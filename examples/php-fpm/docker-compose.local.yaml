# WARNING: Make sure the project-folder-name is unique on your server!
# You should disable port-exposure in production!

services:
    php:
        image: ghcr.io/jonaaix/laravel-aio:1.3-php8.4-fpm
        stop_grace_period: 60s
        volumes:
            - ./:/app:rw
        environment:
            ENV_DEV: true
            DEV_NPM_RUN_DEV: true
            ENABLE_HORIZON_WORKER: true
        ports:
            - "8000:8000" # php
            - "5173:5173" # vite
        depends_on:
            - mariadb
            - redis

    mariadb:
        image: mariadb:lts
        command:
            - '--character-set-server=utf8mb4'
            - '--collation-server=utf8mb4_unicode_ci'
            - '--skip-name-resolve' # Disable DNS lookups (not needed in Docker, improves performance)
        volumes:
            - db_volume:/var/lib/mysql/:delegated
        cap_add:
            - SYS_NICE # Allow the container to adjust process priority (optional for performance tuning)
        environment:
            MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
            MARIADB_USER: ${DB_USERNAME}
            MARIADB_PASSWORD: ${DB_PASSWORD}
            MARIADB_DATABASE: ${DB_DATABASE}
        ports:
            - "3306:3306"
        restart: unless-stopped

    redis:
        image: redis:8-alpine
        volumes:
            - redis_volume:/data
        command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD}" ]
        ports:
            - "6379:6379"
        restart: unless-stopped

    mailpit:
        image: axllent/mailpit:latest
        ports:
            - "1025:1025" # SMTP port
            - "8025:8025" # Web UI port
        volumes:
            - mailpit-data:/data


volumes:
    mailpit-data:
    redis_volume:
    db_volume:
